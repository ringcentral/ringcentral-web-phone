!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("sip.js"),require("getstats")):"function"==typeof define&&define.amd?define(["sip.js","getstats"],t):"object"==typeof exports?exports.WebPhone=t(require("sip.js"),require("getstats")):(e.RingCentral=e.RingCentral||{},e.RingCentral.WebPhone=t(e.SIP,e.getStats))}(window,function(n,i){return(s={},r.m=o=[function(e,t){e.exports=n},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultMediaConstraints=t.responseTimeout=t.uuidKey=t.messages=void 0,t.messages={park:{reqid:1,command:"callpark"},startRecord:{reqid:2,command:"startcallrecord"},stopRecord:{reqid:3,command:"stopcallrecord"},flip:{reqid:3,command:"callflip",target:""},monitor:{reqid:4,command:"monitor"},barge:{reqid:5,command:"barge"},whisper:{reqid:6,command:"whisper"},takeover:{reqid:7,command:"takeover"},toVoicemail:{reqid:11,command:"toVoicemail"},ignore:{reqid:12,command:"ignore"},receiveConfirm:{reqid:17,command:"receiveConfirm"},replyWithMessage:{reqid:14,command:"replyWithMessage"}},t.uuidKey="rc-webPhone-uuid",t.responseTimeout=6e4,t.defaultMediaConstraints={audio:!0,video:!1}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},r=this&&this.__generator||function(n,i){var r,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(n,a)}catch(e){t=[6,e],o=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.extend=t.delay=t.uuid=void 0,t.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},t.delay=function(t){return i(void 0,void 0,void 0,function(){return r(this,function(e){return[2,new Promise(function(e){return setTimeout(e,t)})]})})},t.extend=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),Object.assign(e||{},t||{})}},function(e,t,n){"use strict";var i,r,o,s,d=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},l=this&&this.__generator||function(n,i){var r,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(n,a)}catch(e){t=[6,e],o=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaStreams=t.MediaStreamsImpl=t.RTPReport=t.Browsers=void 0,(r=i=i||{}).new="mediaConnectionStateNew",r.checking="mediaConnectionStateChecking",r.connected="mediaConnectionStateConnected",r.completed="mediaConnectionStateCompleted",r.failed="mediaConnectionStateFailed",r.disconnected="mediaConnectionStateDisconnected",r.closed="mediaConnectionStateClosed",(s=o=t.Browsers||(t.Browsers={})).MSIE="IE",s.Chrome="Chrome",s.Firefox="Firefox",s.Safari="Safari",s.Opera="Opera";var a=function(){this.outboundRtpReport={},this.inboundRtpReport={},this.rttMS={},this.localCandidates=[],this.remoteCandidates=[],this.transport={}};t.RTPReport=a;var c=(Object.defineProperty(u.prototype,"onRTPStat",{set:function(e){this.mediaStreamsImpl.onRTPStat=e},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"onMediaConnectionStateChange",{set:function(e){this.mediaStreamsImpl.onMediaConnectionStateChange=e},enumerable:!1,configurable:!0}),u);function u(e){this.mediaStreamsImpl=new h(e),this.release=this.mediaStreamsImpl.release.bind(this.mediaStreamsImpl),this.reconnectMedia=this.mediaStreamsImpl.reconnectMedia.bind(this.mediaStreamsImpl),this.getMediaStats=this.mediaStreamsImpl.getMediaStats.bind(this.mediaStreamsImpl),this.stopMediaStats=this.mediaStreamsImpl.stopMediaStats.bind(this.mediaStreamsImpl)}t.MediaStreams=c,t.default=c;var h=(p.prototype.getMediaStats=function(e,t){var n=this;void 0===e&&(e=null),void 0===t&&(t=1e3),e&&(this.onRTPStat=e),this.mediaStatsTimer&&(clearTimeout(this.mediaStatsTimer),this.mediaStatsTimer=null),this.mediaStatsTimer=setInterval(function(){n.mediaStatsTimerCallback()},t)},p.prototype.mediaStatsTimerCallback=function(){var e=this.session.sessionDescriptionHandler.peerConnection;if(e){var t=e.iceConnectionState;if("connected"===t||"completed"===t){var n=this.session.listeners("rtpStat");!this.session.onRTPStat&&!this.onRTPStat&&n.length<=0?this.rcWPLoge(this.ktag,'No callback to accept receive media report. usage: session.on("rtpStat") = function(report) or session.onRTPStat = function(report) or set a mediaCallback as a paramter'):this.getRTPReport(new a)}else this.preRTT.currentRoundTripTime=0}else this.rcWPLoge(this.ktag,"the peer connection cannot be null")},p.prototype.stopMediaStats=function(){this.mediaStatsTimer&&(clearTimeout(this.mediaStatsTimer),this.onRTPStat=null)},Object.defineProperty(p.prototype,"tag",{get:function(){return this.ktag},enumerable:!1,configurable:!0}),p.prototype.onPeerConnectionStateChange=function(e){var t="unknown";i.hasOwnProperty(e.peerConnection.iceConnectionState)?(t=i[e.peerConnection.iceConnectionState],this.onMediaConnectionStateChange?this.onMediaConnectionStateChange(this.session,t):this.session&&this.session.onMediaConnectionStateChange?this.session.onMediaConnectionStateChange(this.session,t):this.session.emit(t)):this.rcWPLogd(this.tag,"Unknown peerConnection state: "+e.peerConnection.iceConnectionState),this.rcWPLogd(this.tag,"peerConnection State: "+t)},p.prototype.reconnectMedia=function(c){var u=this;return new Promise(function(s,a){return d(this,void 0,void 0,function(){var t,n,i,r,o;return l(this,function(e){switch(e.label){case 0:if(!u.session)return[3,6];t={offerToReceiveAudio:1,offerToReceiveVideo:0,iceRestart:!0},n=c&&c.RTCOptions||t,(c=c||{}).extraHeaders||(c.extraHeaders=u.session.ua.defaultHeaders),c.eventHandlers={succeeded:s,failed:a},i=u.session.sessionDescriptionHandler.peerConnection,r=void 0,e.label=1;case 1:return e.trys.push([1,4,,5]),[4,i.createOffer(n)];case 2:return r=e.sent(),u.session.sessionDescriptionHandler.on("iceCandidate",u.onIceCandidate),[4,i.setLocalDescription(r)];case 3:return e.sent(),u.rcWPLogd(u.tag,"reconnecting media"),s("reconnecting media"),[3,5];case 4:return o=e.sent(),u.rcWPLoge(u.tag,o),a(o),[3,5];case 5:return[3,7];case 6:a(new Error("The session cannot be empty")),e.label=7;case 7:return[2]}})})})},p.prototype.getRTPReport=function(r){var t=this,n=this;n.session.sessionDescriptionHandler.peerConnection.getStats().then(function(e){e.forEach(function(t){switch(t.type){case"inbound-rtp":Object.keys(t).forEach(function(e){switch(e){case"bytesReceived":case"packetsReceived":case"jitter":case"packetsLost":case"fractionLost":case"mediaType":r.inboundRtpReport[e]=t[e];break;case"roundTripTime":r.rttMS[e]=t[e]}});break;case"outbound-rtp":Object.keys(t).forEach(function(e){switch(e){case"bytesSent":case"packetsSent":case"mediaType":r.outboundRtpReport[e]=t[e]}});break;case"candidate-pair":Object.keys(t).forEach(function(e){switch(e){case"currentRoundTripTime":r.rttMS[e]=t[e]}});break;case"local-candidate":var n={};Object.keys(t).forEach(function(e){switch(e){case"id":case"isRemote":case"ip":case"candidateType":case"networkType":case"priority":case"port":n[e]=t[e]}}),r.localCandidates.push(n);break;case"remote-candidate":var i={};Object.keys(t).forEach(function(e){switch(e){case"id":case"isRemote":case"ip":case"priority":case"port":case"candidateType":i[e]=t[e]}}),r.remoteCandidates.push(i);break;case"media-source":r.outboundRtpReport.rtpLocalAudioLevel=t.audioLevel?t.audioLevel:0;break;case"track":if(!t.remoteSource)break;r.inboundRtpReport.rtpRemoteAudioLevel=t.audioLevel?t.audioLevel:0;break;case"transport":Object.keys(t).forEach(function(e){switch(e){case"dtlsState":case"packetsSent":case"packetsReceived":case"selectedCandidatePairChanges":case"selectedCandidatePairId":r.transport[e]=t[e]}})}}),r.rttMS.hasOwnProperty("currentRoundTripTime")?r.rttMS.currentRoundTripTime=Math.round(1e3*r.rttMS.currentRoundTripTime):r.rttMS.hasOwnProperty("roundTripTime")?(r.rttMS.currentRoundTripTime=r.rttMS.roundTripTime,delete r.rttMS.roundTripTime):r.rttMS.currentRoundTripTime=n.preRTT.currentRoundTripTime,r.rttMS.hasOwnProperty("currentRoundTripTime")&&(n.preRTT.currentRoundTripTime=r.rttMS.currentRoundTripTime),n.session&&(n.session.onRTPStat?n.session.onRTPStat(r,n.session):n.onRTPStat?n.onRTPStat(r,n.session):n.session.emit("rtpStat",r,n.session))}).catch(function(e){t.rcWPLoge(n.ktag,JSON.stringify(e))})},p.prototype.browser=function(){return 0<=navigator.userAgent.search("MSIE")?o.MSIE:0<=navigator.userAgent.search("Chrome")?o.Chrome:0<=navigator.userAgent.search("Firefox")?o.Firefox:0<=navigator.userAgent.search("Safari")&&navigator.userAgent.search("Chrome")<0?o.Safari:0<=navigator.userAgent.search("Opera")?o.Opera:"unknown"},p.prototype.release=function(){this.mediaStatsTimer&&(clearTimeout(this.mediaStatsTimer),this.mediaStatsTimer=null),this.session&&(this.session.sessionDescriptionHandler.removeListener("iceConnection",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionChecking",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionConnected",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionCompleted",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionFailed",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionDisconnected",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionClosed",this.onStateChange))},p.prototype.rcWPLoge=function(e,t){this.session&&this.session.logger.error(e+" "+t)},p.prototype.rcWPLogd=function(e,t){this.session&&this.session.logger.log(e+" "+t)},p);function p(e){var t=this;if(this.ktag="MediaStreams",this.onIceCandidate=function(e){null===e.candidate&&(t.rcWPLogd(t.tag,"ice candidate completed for reconnect media"),t.session.sessionDescriptionHandler.off("iceCandidate",t.onIceCandidate),t.session.reinvite())},this.ktag="MediaStreams",!e)throw this.rcWPLoge(this.ktag,"The session cannot be null!"),new Error("Fail to create the media session. session is null or undefined!");this.session=e,this.onMediaConnectionStateChange=null,this.onStateChange=this.onPeerConnectionStateChange.bind(this),this.session&&this.session.sessionDescriptionHandler&&(this.session.sessionDescriptionHandler.on("iceConnection",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionChecking",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionConnected",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionCompleted",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionFailed",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionDisconnected",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionClosed",this.onStateChange)),this.isChrome=this.browser()===o.Chrome,this.isFirefox=this.browser()===o.Firefox,this.isSafari=this.browser()===o.Safari,this.preRTT={currentRoundTripTime:0},this.isChrome||this.isFirefox||this.isSafari||this.rcWPLoge(this.ktag,"The web browser "+this.browser()+" is not in the recommended list [Chrome, Safari, Firefox] !")}t.MediaStreamsImpl=h},function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});var T=n(5),R=n(0),_=n(1),x=n(2),s=o(n(3)),I=n(12).version,a=(c.version="0.8.9",c.uuid=x.uuid,c.delay=x.delay,c.extend=x.extend,c.MediaStreams=s.default,c.MediaStreamsImpl=s.MediaStreamsImpl,c);function c(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.sipInfo=e.sipInfo[0]||e.sipInfo,this.sipFlags=e.sipFlags,this.uuidKey=t.uuidKey||_.uuidKey;var n=t.uuid||localStorage.getItem(this.uuidKey)||x.uuid();localStorage.setItem(this.uuidKey,n),this.appKey=t.appKey,this.appName=t.appName,this.appVersion=t.appVersion;var i=navigator.userAgent.match(/\((.*?)\)/),r=(i&&i.length&&i[1]).replace(/[^a-zA-Z0-9.:_]+/g,"-")||"",o=(t.appName?t.appName+(t.appVersion?"/"+t.appVersion:"")+" ":"")+(r||"")+" RCWEBPHONE/"+I,s=t.modifiers||[];!1!==t.enableDefaultModifiers&&(s.push(R.Web.Modifiers.stripG722),s.push(R.Web.Modifiers.stripTcpCandidates)),t.enableMidLinesInSDP&&s.push(R.Web.Modifiers.addMidLines);var a="unified-plan";t.enablePlanB&&(a="plan-b");var c=t.stunServers||this.sipInfo.stunServers||["stun.l.google.com:19302"],u=t.turnServers,d=t.iceTransportPolicy||"all",l=[];t.enableTurnServers&&void 0!==t.turnServers&&0!==t.turnServers.length&&(u.forEach(function(e){l.push(e)}),t.iceCheckingTimeout=t.iceCheckingTimeout||2e3),c.forEach(function(e){e=/^(stun:)/.test(e)?e:"stun:"+e,l.push({urls:e})});var h=t.sessionDescriptionHandlerFactoryOptions||{peerConnectionOptions:{iceCheckingTimeout:t.iceCheckingTimeout||this.sipInfo.iceCheckingTimeout||this.sipInfo.iceGatheringTimeout||500,rtcConfiguration:{sdpSemantics:a,iceServers:l,iceTransportPolicy:d}},constraints:t.mediaConstraints||_.defaultMediaConstraints,modifiers:s},p=navigator.userAgent.toLowerCase(),f=!1;-1<p.indexOf("safari")&&p.indexOf("chrome")<0||-1<p.indexOf("firefox")&&p.indexOf("chrome")<0&&(f=!0),f&&(h.alwaysAcquireMediaFirst=!0);var m=t.sessionDescriptionHandlerFactory||[],g=e.sipErrorCodes&&e.sipErrorCodes.length?e.sipErrorCodes:["408","502","503","504"],v=[];this.sipInfo.outboundProxy&&this.sipInfo.transport&&v.push({wsUri:this.sipInfo.transport.toLowerCase()+"://"+this.sipInfo.outboundProxy,weight:10}),this.sipInfo.outboundProxyBackup&&this.sipInfo.transport&&v.push({wsUri:this.sipInfo.transport.toLowerCase()+"://"+this.sipInfo.outboundProxyBackup,weight:0}),v=v.length?v:this.sipInfo.wsServers;var S=t.maxReconnectionAttemptsNoBackup||15,b=t.maxReconnectionAttemptsWithBackup||10,y=t.reconnectionTimeoutNoBackup||5,C=t.reconnectionTimeoutWithBackup||4,w={uri:"sip:"+this.sipInfo.username+"@"+this.sipInfo.domain,transportOptions:{wsServers:v,traceSip:!0,maxReconnectionAttempts:1===v.length?S:b,reconnectionTimeout:1===v.length?y:C,connectionTimeout:5},authorizationUser:this.sipInfo.authorizationId,password:this.sipInfo.password,log:{level:t.logLevel||1,builtinEnabled:void 0===t.builtinEnabled||t.builtinEnabled,connector:t.connector||null},domain:this.sipInfo.domain,autostart:!1,autostop:void 0===t.autoStop||t.autoStop,register:!0,userAgentString:o,sessionDescriptionHandlerFactoryOptions:h,sessionDescriptionHandlerFactory:m,allowLegacyNotifications:!0,registerOptions:{instanceId:t.instanceId||void 0,regId:t.regId||void 0}};t.sipErrorCodes=g,t.switchBackInterval=this.sipInfo.switchBackInterval,this.userAgent=T.patchUserAgent(new R.UA(w),this.sipInfo,t,n)}t.default=a},function(e,t,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},o=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.patchUserAgent=void 0;var s=n(6),a=n(7),c=n(11);function u(e){return e.body=e.body||"",'<Msg><Hdr SID="'+e.sid+'" Req="'+e.request+'" From="'+e.from+'" To="'+e.to+'" Cmd="'+e.reqid+'"/> <Bdy Cln="'+this.sipInfo.authorizationId+'" '+e.body+"/></Msg>"}function d(t,r){var o=this,s={contentType:"x-rc/agent",extraHeaders:[]};return s.extraHeaders.push("P-rc-ws: "+this.contact),new Promise(function(n,i){var e=o.message(t,r,s);e.once("accepted",function(e,t){return n(e)}),e.once("failed",function(e,t){return i(new Error(t))})})}t.patchUserAgent=function(i,e,t,n){return i.defaultHeaders=["P-rc-endpoint-id: "+n,"Client-id:"+t.appKey],i.media={},i.enableQos=t.enableQos,i.enableMediaReportLogging=t.enableMediaReportLogging,i.qosCollectInterval=t.qosCollectInterval||5e3,t.media&&t.media.remote&&t.media.local?(i.media.remote=t.media.remote,i.media.local=t.media.local):i.media=null,i.sipInfo=e,i.__invite=i.invite,i.invite=function(e,t){void 0===t&&(t={});t.extraHeaders=(t.extraHeaders||[]).concat(this.defaultHeaders),t.extraHeaders.push("P-Asserted-Identity: sip:"+(t.fromNumber||this.sipInfo.username)+"@"+this.sipInfo.domain),t.homeCountryId&&t.extraHeaders.push("P-rc-country-id: "+t.homeCountryId);return t.RTCConstraints=t.RTCConstraints||{optional:[{DtlsSrtpKeyAgreement:"true"}]},this.audioHelper.playOutgoing(!0),this.logger.log("Invite to "+e+" created with playOutgoing set to true"),a.patchSession(this.__invite(e,t))}.bind(i),i.__register=i.register,i.register=function(e){void 0===e&&(e={});return this.__register.call(this,r(r({},e),{extraHeaders:o(e.extraHeaders||[],this.defaultHeaders)}))}.bind(i),i.__unregister=i.unregister,i.unregister=function(e){void 0===e&&(e={});return this.__unregister.call(this,r(r({},e),{extraHeaders:o(e.extraHeaders||[],this.defaultHeaders)}))}.bind(i),i.switchFrom=function(e,t){void 0===t&&(t={});var n=[];n.push("Replaces: "+e.id+";to-tag="+e.sipData.fromTag+";from-tag="+e.sipData.toTag),n.push("RC-call-type: replace");var i="Outbound"===e.direction?e.to:e.from,r="Outbound"===e.direction?e.from:e.to;return t.extraHeaders=(t.extraHeaders||[]).concat(n),t.fromNumber=t.fromNumber||r,this.invite(i,t)}.bind(i),i.audioHelper=new s.AudioHelper(t.audioHelper),i.__transportConstructor=i.configuration.transportConstructor,i.configuration.transportConstructor=c.TransportConstructorWrapper(i.__transportConstructor,t),i.onSession=t.onSession||null,i.createRcMessage=u,i.sendMessage=d,i.__onTransportConnected=i.onTransportConnected,i.onTransportConnected=function(){if(this.configuration.register)return this.register()}.bind(i),i.on("invite",function(t){i.audioHelper.playIncoming(!0),a.patchSession(t),a.patchIncomingSession(t),t.logger.log("UA recieved incoming call invite"),t._sendReceiveConfirmPromise=t.sendReceiveConfirm().then(function(){t.logger.log("sendReceiveConfirm success")}).catch(function(e){t.logger.error("failed to send receive confirmation via SIP MESSAGE due to "+e)})}),i.on("registrationFailed",function(e){if(e){var t=e.data||e;t&&"string"==typeof t&&i.transport.isSipErrorCode(t)&&i.transport.onSipErrorCode(),i.logger.warn("UA Registration Failed")}}),i.on("notify",function(e){var t=e.request,n=t&&t.headers&&t.headers.Event&&t.headers.Event[0];n&&"check-sync"===n.raw&&i.emit("provisionUpdate"),i.logger.log("UA recieved notify")}),i.start(),i}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioHelper=void 0;var i=(r.prototype._playSound=function(e,t,n){if(!this._enabled||!e)return this;if(this._audio[e])if(t)this._audio[e].currentTime=0,this._audio[e].playPromise=this._audio[e].play();else{var i=this._audio[e];void 0!==i.playPromise&&i.playPromise.then(function(){i.pause()})}else t&&(this._audio[e]=new Audio,this._audio[e].src=e,this._audio[e].loop=!0,this._audio[e].volume=n,this._audio[e].playPromise=this._audio[e].play());return this},r.prototype.loadAudio=function(e){this._incoming=e.incoming,this._outgoing=e.outgoing,this._audio={}},r.prototype.setVolume=function(e){for(var t in e<0&&(e=0),1<e&&(e=1),this.volume=e,this._audio)this._audio.hasOwnProperty(t)&&(this._audio[t].volume=e)},r.prototype.playIncoming=function(e){return this._playSound(this._incoming,e,this.volume||.5)},r.prototype.playOutgoing=function(e){return this._playSound(this._outgoing,e,this.volume||1)},r);function r(e){void 0===e&&(e={}),this._enabled=!!e.enabled,this.loadAudio(e)}t.AudioHelper=i},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},a=this&&this.__generator||function(n,i){var r,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(n,a)}catch(e){t=[6,e],o=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},o=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.patchIncomingSession=t.patchSession=void 0;var l=n(0),h=n(1),i=n(8),p=n(2),c=n(3),u=n(10);t.patchSession=function(n){if(n.__patched)return n;n.__patched=!0,n.__sendRequest=n.sendRequest,n.__receiveRequest=n.receiveRequest,n.__accept=n.accept,n.__hold=n.hold,n.__unhold=n.unhold,n.__dtmf=n.dtmf,n.__reinvite=n.reinvite,n.sendRequest=function(e,t){return e!==l.C.PRACK?this.__sendRequest(e,t):this}.bind(n),n.receiveRequest=T.bind(n),n.accept=function(r){var o=this;void 0===r&&(r={});return(r=r||{}).extraHeaders=(r.extraHeaders||[]).concat(this.ua.defaultHeaders),r.RTCConstraints=r.RTCConstraints||{optional:[{DtlsSrtpKeyAgreement:"true"}]},new Promise(function(e,t){function n(){e(o),o.removeListener("failed",i)}var i=function(e){t(e),o.removeListener("accepted",n)};o.once("accepted",n),o.once("failed",i),o.__accept(r)})}.bind(n),n.hold=function(){return s(this,void 0,void 0,function(){var t,n;return a(this,function(e){switch(e.label){case 0:if(this.status!==l.Session.C.STATUS_WAITING_FOR_ACK&&this.status!==l.Session.C.STATUS_CONFIRMED)throw new l.Exceptions.InvalidStateError(this.status);if(this.localHold)throw new Error("Session already on hold");this.stopMediaStats(),(t={modifiers:[]}).modifiers.push(this.sessionDescriptionHandler.holdModifier),e.label=1;case 1:return e.trys.push([1,3,,4]),this.logger.log("Hold Initiated"),[4,this._sendReinvite(t)];case 2:return n=e.sent(),this.localHold=200===n.statusCode&&"sendonly"===this.sessionDescriptionHandler.getDirection(),this.logger.log("Hold completed, localhold is set to "+this.localHold),[3,4];case 3:throw e.sent(),new Error("Hold could not be completed");case 4:return[2]}})})}.bind(n),n.unhold=function(){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:if(this.status!==l.Session.C.STATUS_WAITING_FOR_ACK&&this.status!==l.Session.C.STATUS_CONFIRMED)throw new l.Exceptions.InvalidStateError(this.status);if(!this.localHold)throw new Error("Session not on hold, cannot unhold");e.label=1;case 1:return e.trys.push([1,3,,4]),this.logger.log("Unhold Initiated"),[4,this._sendReinvite()];case 2:return t=e.sent(),this.localHold=200===t.statusCode&&"sendonly"===this.sessionDescriptionHandler.getDirection(),this.logger.log("Unhold completed, localhold is set to "+this.localHold),[3,4];case 3:throw e.sent(),new Error("Unhold could not be completed");case 4:return[2]}})})}.bind(n),n.dtmf=function(e,t,n){void 0===t&&(t=100);void 0===n&&(n=50);t=parseInt(t.toString()),n=parseInt(n.toString());var i=this.sessionDescriptionHandler.peerConnection.getSenders().find(function(e){return e.track&&"audio"===e.track.kind}).dtmf;if(void 0!==i&&i)return this.logger.log("Send DTMF: "+e+" Duration: "+t+" InterToneGap: "+n),i.insertDTMF(e,t,n);var r=i&&!i.canInsertDTMF?"can't insert DTMF":"Unknown";throw new Error("Send DTMF failed: "+(i?r:"no sender"))}.bind(n),n.reinvite=function(e,t){void 0===e&&(e={});void 0===t&&(t=null);return e.sessionDescriptionHandlerOptions=e.sessionDescriptionHandlerOptions||{},this.__reinvite(e,t)}.bind(n),n.warmTransfer=function(t,n){void 0===n&&(n={});return s(this,void 0,void 0,function(){return a(this,function(e){return n.extraHeaders=(n.extraHeaders||[]).concat(this.ua.defaultHeaders),this.logger.log("Completing warm transfer"),[2,Promise.resolve(this.refer(t,n))]})})}.bind(n),n.blindTransfer=function(e,t){void 0===t&&(t={});return this.logger.log("Call transfer initiated"),Promise.resolve(this.refer(e,t))}.bind(n),n.transfer=function(t,n){void 0===n&&(n={});return s(this,void 0,void 0,function(){return a(this,function(e){return n.extraHeaders=(n.extraHeaders||[]).concat(this.ua.defaultHeaders),[2,this.blindTransfer(t,n)]})})}.bind(n),n.park=function(){return C(this,h.messages.park)}.bind(n),n.forward=function(i,r,o){return s(this,void 0,void 0,function(){var t,n=this;return a(this,function(e){switch(e.label){case 0:return t=null,[4,this.accept(r)];case 1:return e.sent(),[2,new Promise(function(e){t=setInterval(function(){n.status===l.Session.C.STATUS_CONFIRMED&&(clearInterval(t),n.mute(),setTimeout(function(){e(n.transfer(i,o))},700))},50)})]}})})}.bind(n),n.startRecord=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,w(this,!0)]})})}.bind(n),n.stopRecord=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,w(this,!1)]})})}.bind(n),n.flip=function(t){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,C(this,h.messages.flip,{target:t})]})})}.bind(n),n.whisper=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,C(this,h.messages.whisper)]})})}.bind(n),n.barge=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,C(this,h.messages.barge)]})})}.bind(n),n.mute=function(e){if(this.status!==l.Session.C.STATUS_CONFIRMED)return void this.logger.warn("An active call is required to mute audio");this.logger.log("Muting Audio"),e||this.emit("muted",this);return R(this,!0)}.bind(n),n.unmute=function(e){if(this.status!==l.Session.C.STATUS_CONFIRMED)return void this.logger.warn("An active call is required to unmute audio");this.logger.log("Unmuting Audio"),e||this.emit("unmuted",this);return R(this,!1)}.bind(n),n.onLocalHold=function(){return this.localHold}.bind(n),n.media=n.ua.media,n.addTrack=_.bind(n),n.stopMediaStats=function(){if(this.logger.log("Stopping media stats collection"),!this)return;this.mediaStreams&&this.mediaStreams.stopMediaStats(),this.mediaStatsStarted=!1,this.noAudioReportCount=0}.bind(n),n.getIncomingInfoContent=function(e){if(!e||!e.body)return{};var t={};try{t=JSON.parse(e.body)}catch(e){return{}}return t}.bind(n),n.sendMoveResponse=function(e,t,n,i){void 0===i&&(i={});var r=o(i.extraHeaders||[],this.ua.defaultHeaders,["Content-Type: application/json;charset=utf-8"]);this.sendRequest(l.C.INFO,{body:JSON.stringify({response:{reqId:e,command:"move",result:{code:t,description:n}}}),extraHeaders:r})}.bind(n),n.sendReceive=C.bind(n),n._sendReinvite=function(o){void 0===o&&(o={});return s(this,void 0,void 0,function(){var n,t,i,r=this;return a(this,function(e){switch(e.label){case 0:if(this.pendingReinvite)throw new Error("Reinvite in progress. Please wait until complete, then try again.");if(!this.sessionDescriptionHandler)throw new Error("No SessionDescriptionHandler, can't send reinvite..");this.pendingReinvite=!0,o.modifiers=o.modifiers||[],e.label=1;case 1:return e.trys.push([1,5,,6]),[4,this.sessionDescriptionHandler.getDescription(o.sessionDescriptionHandlerOptions,o.modifiers)];case 2:return n=e.sent(),[4,new Promise(function(t,e){r.sendRequest(l.C.INVITE,{body:n,receiveResponse:function(e){200===e.statusCode&&t(e)},extraHeaders:["Contact: "+r.contact]})})];case 3:return t=e.sent(),[4,this.receiveReinviteResponse(t)];case 4:return e.sent(),[2,t];case 5:throw i=e.sent(),this.pendingReinvite=!1,new Error("Reinvite Failed with the reason "+i.message);case 6:return[2]}})})}.bind(n),n.on("replaced",t.patchSession),n.on("progress",function(t){e(),183===t.statusCode&&(n.logger.log("Receiving 183 In Progress from server"),n.createDialog(t,"UAC"),n.hasAnswer=!0,n.status=l.Session.C.STATUS_EARLY_MEDIA,n.logger.log("Created UAC Dialog"),n.sessionDescriptionHandler.setDescription(t.body).catch(function(e){n.logger.warn(e),n.failed(t,l.C.causes.BAD_MEDIA_DESCRIPTION),n.terminate({status_code:488,reason_phrase:"Bad Media Description"}),n.logger.log("Call failed with Bad Media Description")}))}),n.media&&n.on("trackAdded",_);var e=function(){n.ua.audioHelper.playOutgoing(!1),n.ua.audioHelper.playIncoming(!1),n.removeListener("accepted",e),n.removeListener("rejected",e),n.removeListener("bye",e),n.removeListener("terminated",e),n.removeListener("cancel",e),n.removeListener("failed",e),n.removeListener("replaced",e)};return n.on("accepted",e),n.on("rejected",e),n.on("bye",e),n.on("terminated",e),n.on("cancel",e),n.on("failed",e),n.on("replaced",e),n.on("reinviteAccepted",t.patchIncomingSession),n.ua.enableQos&&n.on("SessionDescriptionHandler-created",function(){n.logger.log("SessionDescriptionHandler Created"),i.startQosStatsCollection(n),navigator.mediaDevices.enumerateDevices().then(function(e){e.forEach(function(e){n.logger.log(e.kind+" = "+e.label+JSON.stringify(e))})})}),n.ua.onSession&&n.ua.onSession(n),n.mediaStatsStarted=!1,n.noAudioReportCount=0,n.reinviteForNoAudioSent=!1,n.__shouldSendReinviteOnReconnect=!1,n.ua.transport.on("disconnected",function(){n.logger.log("Websocket disconnected. Setting __shouldSendReinviteOnReconnect to true"),n.__shouldSendReinviteOnReconnect=!0}),n.ua.on("registered",function(){return s(void 0,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return n.__shouldSendReinviteOnReconnect?(n.logger.log("Sending reinvite after successful registration"),[4,n.reinvite()]):[3,2];case 1:e.sent(),n.logger.log("Reinvite sent"),n.__shouldSendReinviteOnReconnect=!1,e.label=2;case 2:return[2]}})})}),n},t.patchIncomingSession=function(t){try{r(t)}catch(e){t.logger.error("Can't parse RC headers from invite request due to "+e)}t.canUseRCMCallControl=f,t.createSessionMessage=m,t.sendSessionMessage=v,t.sendReceiveConfirm=S,t.ignore=g,t.toVoicemail=b,t.replyWithMessage=y,t.receiveRequest=T};var r=function(e){var t=e.request.headers["P-Rc"],n=e.request.headers["P-Rc-Api-Call-Info"];if(t&&t.length){var i=t[0].raw,r=(new DOMParser).parseFromString(i,"text/xml"),o=r.getElementsByTagName("Hdr")[0],s=r.getElementsByTagName("Bdy")[0];o&&(e.rcHeaders={sid:o.getAttribute("SID"),request:o.getAttribute("Req"),from:o.getAttribute("From"),to:o.getAttribute("To")}),s&&p.extend(e.rcHeaders,{srvLvl:s.getAttribute("SrvLvl"),srvLvlExt:s.getAttribute("SrvLvlExt"),nm:s.getAttribute("Nm"),toNm:s.getAttribute("ToNm")})}if(n&&n.length){var a=n[0].raw;if(a){var c=function(e){void 0===e&&(e="");var r={};return e.split(/; */).forEach(function(e){var t=e.indexOf("=");if(!(t<0)){var n=e.substr(0,t).trim(),i=e.substr(++t,e.length).trim();void 0===r[n]&&(r[n]=i)}}),r}(a);p.extend(e.rcHeaders,c)}}},d=2e3;function f(){return!!this.rcHeaders}function m(e){if(this.rcHeaders)return p.extend(e,{sid:this.rcHeaders.sid,request:this.rcHeaders.request,from:this.rcHeaders.to,to:this.rcHeaders.from}),this.ua.createRcMessage(e)}function g(){return s(this,void 0,void 0,function(){var t=this;return a(this,function(e){return[2,this._sendReceiveConfirmPromise.then(function(){return t.sendSessionMessage(h.messages.ignore)})]})})}function v(t){return s(this,void 0,void 0,function(){return a(this,function(e){return this.rcHeaders||this.logger.error("Can't send SIP MESSAGE related to session: no RC headers available"),[2,this.ua.sendMessage(this.rcHeaders.from,this.createSessionMessage(t))]})})}function S(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,this.sendSessionMessage(h.messages.receiveConfirm)]})})}function b(){return s(this,void 0,void 0,function(){var t=this;return a(this,function(e){return[2,this._sendReceiveConfirmPromise.then(function(){return t.sendSessionMessage(h.messages.toVoicemail)})]})})}function y(i){return s(this,void 0,void 0,function(){var t,n=this;return a(this,function(e){return t='RepTp="'+i.replyType+'"',0===i.replyType?t+=' Bdy="'+i.replyText+'"':1!==i.replyType&&4!==i.replyType||(t+=' Vl="'+i.timeValue+'"',t+=' Units="'+i.timeUnits+'"',t+=' Dir="'+i.callbackDirection+'"'),[2,this._sendReceiveConfirmPromise.then(function(){return n.sendSessionMessage({reqid:h.messages.replyWithMessage.reqid,body:t})})]})})}function C(u,d,t){return s(this,void 0,void 0,function(){var c;return a(this,function(e){return t=t||{},p.extend(d,t),delete d.extraHeaders,[2,new Promise(function(s,a){var e=(t.extraHeaders||[]).concat(u.ua.defaultHeaders).concat(["Content-Type: application/json;charset=utf-8"]);u.sendRequest(l.C.INFO,{body:JSON.stringify({request:d}),extraHeaders:e,receiveResponse:function(i){var r=null;if(200===i.statusCode){c=i.cseq;var o=function(e){if(i.cseq===c){var t,n=e&&e.body||"{}";try{t=JSON.parse(n)}catch(e){t={}}return t.response&&t.response.command===d.command&&t.response.result?(r&&clearTimeout(r),u.removeListener("RC_SIP_INFO",o),"0"===t.response.result.code.toString()?s(t.response.result):a(t.response.result)):void 0}};r=setTimeout(function(){a(new Error("Timeout: no reply")),u.removeListener("RC_SIP_INFO",o)},h.responseTimeout),u.on("RC_SIP_INFO",o)}else a(new Error("The INFO response status code is: "+i.statusCode+" (waiting for 200)"))}})})]})})}function w(i,r){return s(this,void 0,void 0,function(){var t,n;return a(this,function(e){switch(e.label){case 0:return t=r?h.messages.startRecord:h.messages.stopRecord,i.__onRecord&&!r||!i.__onRecord&&r?[4,C(i,t)]:[3,2];case 1:return n=e.sent(),i.__onRecord=!!r,[2,n];case 2:return[2]}})})}function T(e){var t,n,i;switch(e.method){case l.C.UPDATE:return this.logger.log("Receive UPDATE request. Do nothing just return 200 OK"),e.reply(200),this.emit("updateReceived",e),this;case l.C.INFO:var r=this.getIncomingInfoContent(e);if((null===(t=null==r?void 0:r.request)||void 0===t?void 0:t.reqId)&&"move"===(null===(n=null==r?void 0:r.request)||void 0===n?void 0:n.command)&&"rcv"===(null===(i=null==r?void 0:r.request)||void 0===i?void 0:i.target))return e.reply(200),this.emit("moveToRcv",r.request),this;if(this.emit("RC_SIP_INFO",e),this.status===l.Session.C.STATUS_CONFIRMED||this.status===l.Session.C.STATUS_WAITING_FOR_ACK)if(e.getHeader("content-type").match(/^application\/json/i))return e.reply(200),this}return this.__receiveRequest.apply(this,arguments)}function R(e,t){var n=e.sessionDescriptionHandler.peerConnection;n.getSenders&&n.getSenders().forEach(function(e){e.track&&(e.track.enabled=!t)})}function _(e,t){var n,i,r=this,o=this.sessionDescriptionHandler.peerConnection;if(e&&t)n=e,i=t;else{if(!this.media)throw new Error("HTML Media Element not Defined");n=this.media.remote,i=this.media.local}var s=new MediaStream;o.getReceivers?o.getReceivers().forEach(function(e){var t=e.track;t&&(s.addTrack(t),r.logger.log("Remote track added"))}):(s=o.getRemoteStreams()[0],this.logger.log("Remote track added")),n.srcObject=s,n.play().catch(function(){r.logger.error("Remote play was rejected")});var a=new MediaStream;o.getSenders?o.getSenders().forEach(function(e){var t=e.track;t&&"audio"===t.kind&&(a.addTrack(t),r.logger.log("Local track added"))}):(a=o.getLocalStreams()[0],this.logger.log("Local track added")),i.srcObject=a,i.play().catch(function(){r.logger.error("Local play was rejected")}),a&&s&&!this.mediaStatsStarted&&(this.mediaStreams=new c.MediaStreams(this),this.logger.log("Start gathering media report"),this.mediaStatsStarted=!0,this.mediaStreams.getMediaStats(function(e){r.ua.enableMediaReportLogging&&r.logger.log("Got media report: "+JSON.stringify(e)),!r.reinviteForNoAudioSent&&u.isNoAudio(e)?(r.logger.log("No audio report"),r.noAudioReportCount++,3===r.noAudioReportCount&&(r.logger.log("No audio for 6 sec. Trying to recover audio by sending Re-invite"),r.mediaStreams.reconnectMedia(),r.reinviteForNoAudioSent=!0,r.noAudioReportCount=0)):u.isNoAudio(e)||(r.noAudioReportCount=0)},d))}},function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startQosStatsCollection=void 0;function a(e){return parseFloat(e.toString()).toFixed(2)}var o=r(n(9));t.startQosStatsCollection=function(n){var i,r=p();if(r.callID=n.request.callId||"",r.fromTag=n.request.fromTag||"",r.toTag=n.request.toTag||"",r.localID=n.request.headers.From[0].raw||n.request.headers.From[0],r.remoteID=n.request.headers.To[0].raw||n.request.headers.To[0],r.origID=n.request.headers.From[0].raw||n.request.headers.From[0],!o.default)throw new Error("getStats module was not provided!");o.default(n.sessionDescriptionHandler.peerConnection,function(e){i=e,r.status=!0;var t=m(i.connectionType);r.localAddr=i.connectionType.local.ipAddress[0],r.remoteAddr=i.connectionType.remote.ipAddress[0],i.results.forEach(function(e){"localcandidate"===e.type&&(r.localcandidate=e),"remotecandidate"===e.type&&(r.remotecandidate=e),"ssrc"===e.type&&e.id.includes("send")&&n.ua.enableMediaReportLogging&&0===parseInt(e.audioInputLevel,10)&&(n.logger.log("AudioInputLevel is 0. The local track might be muted or could have potential one-way audio issue. Check Microphone Volume settings."),n.emit("no-input-volume")),"ssrc"===e.type&&e.id.includes("recv")&&(r.jitterBufferDiscardRate=e.googSecondaryDiscardedRate||0,r.packetLost=e.packetsLost,r.packetsReceived=e.packetsReceived,r.totalSumJitter+=parseFloat(e.googJitterBufferMs),r.totalIntervalCount+=1,r.JBM=Math.max(r.JBM,parseFloat(e.googJitterBufferMs)),r.netType=f(r.netType,t),n.ua.enableMediaReportLogging&&parseInt(e.audioOutputLevel,10)<=1&&(n.logger.log("Remote audioOutput level is 1. The remote track might be muted or could have potential one-way audio issue"),n.emit("no-output-volume")))})},n.ua.qosCollectInterval),n.on("terminated",function(){i&&i.nomore(),n.logger.log("Release media streams"),n.mediaStreams&&n.mediaStreams.release(),u(n,r)})};var s,c,u=function(e,t,n){void 0===n&&(n={}),n=n||{};var i=navigator.connection.effectiveType||"",r=d(t)||"",o=n.targetUrl||"rtcpxr@rtcpxr.ringcentral.com:5060",s=n.event||"vq-rtcpxr";n.expires=60,n.contentType="application/vq-rtcpxr",n.extraHeaders=(n.extraHeaders||[]).concat(e.ua.defaultHeaders),n.extraHeaders.push("p-rc-client-info:cpuRC=0:0;cpuOS=0:0;netType="+r+";ram=0:0;effectiveType="+i);var a=l(t),c=h(a),u=e.ua.publish(o,s,c,n);e.logger.log("Local Candidate: "+JSON.stringify(t.localcandidate)),e.logger.log("Remote Candidate: "+JSON.stringify(t.remotecandidate)),t.status=!1,u.close(),e.emit("qos-published",c)},d=function(e){for(var t=[],n=0,i=Object.entries(e.netType);n<i.length;n++){var r=i[n],o=r[0],s=r[1];t.push(o+":"+a(100*s/e.totalIntervalCount))}return t.join()},l=function(e){var t=100*e.packetLost/(e.packetsReceived+e.packetLost)||0,n=0<e.totalIntervalCount?e.totalSumJitter/e.totalIntervalCount:0;return i(i({},e),{NLR:a(t),JBN:a(n),JDR:a(e.jitterBufferDiscardRate),MOSLQ:0})},h=function(e){var t=e.NLR||0,n=e.JBM||0,i=e.JBN||0,r=e.JDR||0,o=e.MOSLQ||0,s=e.callID||"",a=e.fromTag||"",c=e.toTag||"",u=e.localID||"";return"VQSessionReport: CallTerm\r\nCallID: "+s+"\r\nLocalID: "+u+"\r\nRemoteID: "+(e.remoteID||"")+"\r\nOrigID: "+u+"\r\nLocalAddr: IP="+(e.localAddr||"")+" SSRC=0x00000000\r\nRemoteAddr: IP="+(e.remoteAddr||"")+" SSRC=0x00000000\r\nLocalMetrics:\r\nTimestamps: START=0 STOP=0\r\nSessionDesc: PT=0 PD=opus SR=0 FD=0 FPP=0 PPS=0 PLC=0 SSUP=on\r\nJitterBuffer: JBA=0 JBR=0 JBN="+i+" JBM="+n+" JBX=0\r\nPacketLoss: NLR="+t+" JDR="+r+"\r\nBurstGapLoss: BLD=0 BD=0 GLD=0 GD=0 GMIN=0\r\nDelay: RTD=0 ESD=0 SOWD=0 IAJ=0\r\nQualityEst: MOSLQ="+o+" MOSCQ=0.0\r\nDialogID: "+s+";to-tag="+c+";from-tag="+a},p=function(){return{localAddr:"",remoteAddr:"",callID:"",localID:"",remoteID:"",origID:"",fromTag:"",toTag:"",timestamp:{start:"",stop:""},netType:{},packetLost:0,packetsReceived:0,jitterBufferNominal:0,jitterBufferMax:0,jitterBufferDiscardRate:0,totalSumJitter:0,totalIntervalCount:0,NLR:"",JBM:0,JBN:"",JDR:"",MOSLQ:0,status:!1,localcandidate:{},remotecandidate:{}}},f=function(e,t){var n;return void 0===e&&(e={}),i(i({},e),((n={})[t]=(t in e?parseInt(e[t]):0)+1,n))};(c=s=s||{}).bluetooth="Bluetooth",c.cellular="Cellulars",c.ethernet="Ethernet",c.wifi="WiFi",c.vpn="VPN",c.wimax="WiMax",c["2g"]="2G",c["3g"]="3G",c["4g"]="4G";var m=function(e){var t=e.systemNetworkType||"unknown",n=e.local.networkType||["unknown"],i=t&&"unknown"!==t?t:n[0];return i in s?s[i]:i}},function(e,t){e.exports=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNoAudio=void 0,t.isNoAudio=function(e){return!e.inboundRtpReport||(!e.outboundRtpReport||(0===e.inboundRtpReport.packetsReceived||0===e.outboundRtpReport.packetsSent))}},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},s=this&&this.__generator||function(n,i){var r,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(n,a)}catch(e){t=[6,e],o=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.TransportConstructorWrapper=void 0,t.TransportConstructorWrapper=function(i,r){return function(e,t){var n=new i(e,t);return n.nextReconnectInterval=0,n.sipErrorCodes=r.sipErrorCodes,n.switchBackInterval=r.switchBackInterval,n.mainProxy=n.configuration.wsServers[0],n.computeRandomTimeout=c,n.reconnect=function(r){return o(this,void 0,void 0,function(){var t,n,i=this;return s(this,function(e){switch(e.label){case 0:return 0<this.reconnectionAttempts&&this.logger.warn("Reconnection attempt "+this.reconnectionAttempts+" failed"),r?(this.logger.warn("forcing connect to main WS server"),[4,this.disconnect({force:!0})]):[3,3];case 1:return e.sent(),this.server=this.getNextWsServer(!0),this.reconnectionAttempts=0,[4,this.connect()];case 2:return e.sent(),[2];case 3:return this.noAvailableServers()?(this.logger.warn("no available ws servers left - going to closed state"),this.status=a.STATUS_CLOSED,this.emit("closed"),this.resetServerErrorStatus(),this.server=this.getNextWsServer(!0),this.__clearSwitchBackTimer(),[2]):this.isConnected()?(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),[4,this.disconnect({force:!0})]):[3,6];case 4:return e.sent(),[4,this.reconnect()];case 5:return e.sent(),[2];case 6:return t=1e3*(this.configuration.reconnectionTimeout-2),n=1e3*(this.configuration.reconnectionTimeout+2),this.reconnectionAttempts+=1,this.nextReconnectInterval=this.computeRandomTimeout(this.reconnectionAttempts,t,n),this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.wsUri),this.logger.warn("transport "+this.server.wsUri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,[4,this.reconnect()]):[3,8];case 7:return e.sent(),[3,9];case 8:this.logger.warn("trying to reconnect to WebSocket "+this.server.wsUri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=setTimeout(function(){i.connect(),i.reconnectTimer=void 0},this.nextReconnectInterval),this.logger.warn("next reconnection attempt in:"+Math.round(this.nextReconnectInterval/1e3)+" seconds."),e.label=9;case 9:return[2]}})})}.bind(n),n.isSipErrorCode=function(e){var t=e.substring(0,e.indexOf("\r\n")).split(" ")[1];return t&&this.sipErrorCodes&&this.sipErrorCodes.length&&this.sipErrorCodes.includes(t)}.bind(n),n.scheduleSwitchBackMainProxy=function(){var e=this,t=this.switchBackInterval?1e3*this.switchBackInterval:null;t?(t+=this.computeRandomTimeout(1,0,9e5),this.logger.warn("Try to switch back to main proxy after "+Math.round(t/1e3/60)+" min"),this.mainProxy.switchBackTimer=setTimeout(function(){e.mainProxy.isError=!1,e.mainProxy.switchBackTimer=null,e.logger.warn("switchBack initiated"),e.emit("switchBackProxy")},t)):this.logger.warn("switchBackInterval is not set. Will be switched with next provision update ")}.bind(n),n.onSipErrorCode=function(){return o(this,void 0,void 0,function(){return s(this,function(e){switch(e.label){case 0:return this.logger.warn("Error received from the server. Disconnecting from the proxy"),this.server.isError=!0,this.emit("transportError"),[4,this.disconnect({force:!0})];case 1:return e.sent(),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,[2,this.reconnect()]}})})}.bind(n),n.__isCurrentMainProxy=function(){return this.server===this.configuration.wsServers[0]}.bind(n),n.__afterWSConnected=function(){this.__isCurrentMainProxy()?this.__onConnectedToMain():this.__onConnectedToBackup()}.bind(n),n.__onConnectedToBackup=function(){this.mainProxy.switchBackTimer||this.scheduleSwitchBackMainProxy()}.bind(n),n.__onConnectedToMain=function(){this.__clearSwitchBackTimer()}.bind(n),n.__clearSwitchBackTimer=function(){this.mainProxy.switchBackTimer&&(clearTimeout(this.mainProxy.switchBackTimer),this.mainProxy.switchBackTimer=null)}.bind(n),n.__connect=n.connect,n.connect=function(t){return o(this,void 0,void 0,function(){var n=this;return s(this,function(e){switch(e.label){case 0:return[4,this.__connect(t).catch(function(t){return o(n,void 0,void 0,function(){return s(this,function(e){switch(e.label){case 0:return this.emit("wsConnectionError",t),this.logger.warn("Connection Error occured. Trying to reconnect to websocket..."),this.onError(t),this.disconnect({force:!0}),this.disposeWs(),[4,this.reconnect()];case 1:return e.sent(),[2]}})})})];case 1:return[2,e.sent()]}})})}.bind(n),n.on("connected",n.__afterWSConnected),n}};var a={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},c=function(e,t,n){if(void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),t<0||n<0||e<1)throw new Error("Arguments must be positive numbers");return Math.floor(Math.random()*Math.abs(n-t))+t+(e-1)*(t+n)/2}},function(e){e.exports={name:"ringcentral-web-phone",version:"0.8.10",scripts:{test:"npm run test:ut && npm run test:e2e","test:coverage":"cat .coverage/lcov.info | coveralls -v","test:e2e":"jest --config jest.config.e2e.js --runInBand","test:ut":"jest --config jest.config.ut.js",build:"npm run build:tsc && npm run build:webpack","build:tsc":"tsc","build:webpack":"cross-env NODE_ENV=production webpack --config webpack.config.js --progress --color",start:"webpack-dev-server --config webpack.config.js --progress --color",server:"http-server --port ${PORT:-8080}",watch:'npm-run-all --print-label --parallel "build:** -- --watch"',lint:"eslint --cache --cache-location node_modules/.cache/eslint --fix","lint:all":'npm run lint "src/**/*.ts" "demo/**/*.js"',"lint:staged":"lint-staged"},dependencies:{getstats:"1.2.0","sip.js":"0.13.5"},devDependencies:{"@types/expect-puppeteer":"3.3.1","@types/jest":"24.0.15","@types/jest-environment-puppeteer":"4.0.0","@types/node":"17.0.32",bootstrap:"3.4.1","cache-loader":"4.0.0","copy-webpack-plugin":"5.0.3",coveralls:"3.0.4","cross-env":"5.2.0",dotenv:"8.0.0",eslint:"6.8.0","eslint-config-ringcentral-typescript":"3.0.0","html-webpack-plugin":"3.2.0","http-server":"0.11.1",husky:"2.4.1","istanbul-instrumenter-loader":"3.0.1",jest:"24.8.0","jest-puppeteer":"4.2.0",jquery:"3.4.1","lint-staged":"8.2.1","npm-run-all":"4.1.5",puppeteer:"1.18.0",ringcentral:"3.2.2","ts-jest":"24.0.2","ts-loader":"6.0.3",typescript:"3.9.2","uglifyjs-webpack-plugin":"2.1.3",webpack:"4.35.0","webpack-cli":"3.3.4","webpack-dev-server":"3.7.2"},preferGlobal:!1,private:!1,main:"./lib/index.js",types:"./lib/index.d.ts",author:{name:"RingCentral, Inc.",email:"devsupport@ringcentral.com"},contributors:[{name:"Kirill Konshin"},{name:"Elias Sun"},{name:"Vyshakh Babji"}],repository:{type:"git",url:"git://github.com/ringcentral/ringcentral-web-phone.git"},bugs:{url:"https://github.com/ringcentral/ringcentral-web-phone/issues"},homepage:"https://github.com/ringcentral/ringcentral-web-phone",engines:{node:">=0.10.36"},license:"MIT"}}],r.c=s,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)).default;function r(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}var o,s});